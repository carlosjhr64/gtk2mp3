#!/usr/bin/env ruby
require 'help_parser'
require 'gtk2mp3'

OPTIONS = HelpParser[Gtk2Mp3::VERSION, <<HELP]
Usage:
  gtk2mp3 [:options+]
Options:
  -h --help
  -v --version
  --noinit    \tDon't reset the playlist
# Notes #
# Signal USR1 will trigger Next! song.
# Requires MPD/MPC.
# See https://www.musicpd.org/clients/mpc/.
HELP

unless OPTIONS.noinit?
  unless system 'ps -C mpd'
    unless system 'mpd'
      $stderr.puts 'Could not start the mpd daemon.'
      exit 69 # EX_UNAVAILABLE
    end
  end
  unless system "mpc --wait update" and
      system "mpc clear"            and
      system "mpc ls | mpc add"     and
      system "mpc consume off"      and
      system "mpc repeat off"       and
      system "mpc random on"        and
      system "mpc single on"
    $stderr.puts 'Could not initialize mpd\'s playlist'
    exit 76 # EX_PROTOCOL
  end
end

Gtk2Mp3.requires
Signal.trap :USR1 do
  Gtk2Mp3.next!(true)
end
Gtk3App.main(Gtk2Mp3)
